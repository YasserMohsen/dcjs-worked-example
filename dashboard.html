<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>

<!-- pull in D3, Crossfilter, and dc.js libraries -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.16/d3.min.js' type='text/javascript'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js' type='text/javascript'></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0-dev/dc.js"></script>

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.0-dev/dc.css"/>
</head>

<body>

<!-- create a table to host the dataTable -->
<table class="dc-data-table"></table>

<script type='text/javascript'>
// okay so it turns out this script needs to be not in the head, but
// in the body (possibly post-body is fine) so it's moved down here

// this is the variable that holds the data table
// note that it will fill in the element with class .dc-data-table,
// which we created in the body
var nasdaqTable = dc.dataTable('.dc-data-table');

// load the data in from the CSV with d3
d3.csv('ndx.csv', function (data) {
    // coerce the data into the correct format (see Step 2)
    var dateFormat = d3.time.format('%m/%d/%Y');
    // add in a new format we'll use to define how numbers
    // are displayed in our new chart
    var numberFormat = d3.format('.2f');

    data.forEach(function (d) {
        d.dd = dateFormat.parse(d.date);
        d.close = +d.close; // coerce to number
        d.open = +d.open;
        d.change = +d.change;
        d.volume = +d.volume
    });

    // load the data into CrossFilter
    var ndx = crossfilter(data);

    // Create a data dimension

    // This is a CrossFilter thing and represents a property of the dataset
    // such as a field or a derived field that you compute with a function
    // Once you have a dimension, you can filter and sort based on it

    // See http://animateddata.co.uk/articles/crossfilter/ by Peter Cook
    // to understand it better

    // We create it outside the table because we will use it in several places
    var dateDimension = ndx.dimension(function (d) {
        return d.dd;
    });

    // create the dataTable
    nasdaqTable
        .dimension(
            // obligatory field :
            // supplying a dimension is necessary for every dc chart type
            dateDimension
        )
        .group(function (d) {
            // obligatory field :
            // specify what to group the rows by
            // In our case, for now, we don't want to group by anything
            // so we just return a constant
            // This will produce a row with that constant string
            // which cannot be removed (for now) without going into the source
            return 'All';
        })
        .size(
            // This is optional. Specify how many records to show
            // The default is 25
            // We want to show all of them for now so we'll make it Infinity
            Infinity
        )
        // There are several ways to specify the columns; see the data-table documentation.
        // This code demonstrates generating the column header automatically based on the columns.
        .columns([
            'date',  // d.date - this column will be labelled Date
            'open',  // d.open - this column will be labelled Open
            'close', // d.close - this column will be labelled Close
            {
                // Specify a custom format for column 'Change'
                // by using a label with a function.
                label: 'Change', // use this as the column label
                format: function (d) {
                    return numberFormat(d.close - d.open);
                }
            },
            'volume' // d.volume - this column will be labelled Volume
        ])
        .sortBy(function (d) {
            // sortBy is optional
            // sort the rows by the date (we can do this because we used
            // dateDimension, which has d.dd as its value!)
            return d.dd;
        })
        .order(
            // sort order is also optional
            // the default is already d3.ascending actually!
            d3.ascending
        )

    // render all charts (in this case )
    dc.renderAll();

});
</script>


</body>

</html>
